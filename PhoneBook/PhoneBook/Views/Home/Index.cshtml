@model List<PhoneBook.Models.Department>
@using Kendo.Mvc

@{
    ViewData["Title"] = "PhoneBook Tree";
}

<div class="row">
    <!-- CỘT TRÁI: Cây Phòng Ban -->
    <div class="col-md-4">
        <h3>Phòng ban</h3>

        <div class="configurator mb-3 p-2 border rounded bg-light">

            <div class="box-col mb-2">
                <ul class="list-inline">
                    <li class="list-inline-item">
                        <button id="expandAllNodes" class="btn btn-sm btn-outline-primary">Mở rộng</button>
                    </li>
                    <li class="list-inline-item">
                        <button id="collapseAllNodes" class="btn btn-sm btn-outline-secondary">Thu nhỏ</button>
                    </li>
                </ul>
            </div>
            <div class="box-col mb-2">
                <ul class="list-inline">
                    <li class="list-inline-item">
                        <input id="filterText" class="form-control form-control-sm d-inline-block w-auto" placeholder="Tìm phòng ban..." />
                        <button id="filterDataSource" class="btn btn-sm btn-outline-dark">Lọc</button>
                    </li>
                </ul>
            </div>
        </div>

        @(Html.Kendo().TreeView()
                .Name("deptTree")
                .DataTextField("text")
                .DataSource(ds => ds
                .Read(r => r.Url(Url.Action("GetDepartments", "Home")))
                .Model(m =>
                {
                    m.Id("id");
                    m.Children("items");
                })
                )
                .Events(e => e.Select("onDeptSelect"))
                )
    </div>

    <!-- CỘT PHẢI: Kendo Grid danh sách nhân viên -->
    <div class="col-md-8">
        <h3>Nhân viên</h3>
        @(Html.Kendo().Grid<PhoneBook.Models.Employee>()
                .Name("employeeGrid")
                .Columns(columns =>
                {
                    columns.Template("<span class='row-number'></span>")
                    .Title("STT")
                    .Width(60)
                    .HtmlAttributes(new { @class = "text-center" });

                    columns.Bound(e => e.FullName).Title("Họ tên");
                    columns.Bound(e => e.WorkingPhone).Title("Điện thoại công việc").Width(150);
                    columns.Bound(e => e.HandPhone).Title("Di động").Width(200);
                    columns.Bound(e => e.HomePhone).Title("Điện thoại nhà").Width(200);

                })

                .Sortable()
                .Filterable(f => f
                .Mode(GridFilterMode.Menu)
                .Messages(m => m
                .Info("Tìm kiếm")
                .Filter("Lọc")
                .Clear("Xóa")
                .And("Và")
                .Or("Hoặc")
                )
                .Extra(false)
                .Operators(o => o
                .ForString(str => str
                .Clear()
                .Contains("Chứa")
                .StartsWith("Bắt đầu với")
                .EndsWith("Kết thúc với")
                )
                )
                )
                .Scrollable(scr => scr.Height(600))
                .Pageable(page => page.PageSizes(true).ButtonCount(5))
                .DataSource(ds => ds
                    .Ajax()
                    .ServerOperation(false)
                    .PageSize(10)
                    .Read(read => read.Url(Url.Action("GetAllEmployees", "Home")))
                    .Model(m =>
                    {
                        m.Id(e => e.UserId);
                    })
                )
                .Events(e => e.DataBound("onGridDataBound"))  // ✅ Gọi global function
                )
        <div id="empCount" class="mt-2 text-end fw-bold text-primary"></div>
    </div>
</div>


@section Scripts {

    <script>
        // ✅ Hàm DataBound để đánh số thứ tự cho Grid
                function onGridDataBound(e) {
            var grid = this;
            var rows = grid.items();
            var page = grid.dataSource.page();
            var pageSize = grid.dataSource.pageSize();
            var index = (page - 1) * pageSize;

            rows.each(function () {
                var row = $(this);
                var numberCell = row.find(".row-number");
                numberCell.text(++index);
            });

            $("#empCount").text(`Tổng số nhân viên: ${grid.dataSource.total()}`);
        }

        // ✅ Hàm Select cho TreeView
        async function onDeptSelect(e) {
            const tree = $("#deptTree").data("kendoTreeView");
            const node = tree.dataItem(e.node);
            const isRoot = (node && (node.parentId === -1 || node.parentId === "-1"));
            const grid = $("#employeeGrid").data("kendoGrid");

            let url = isRoot
                ? "/Home/GetAllEmployees"
                : `/Home/GetEmployeesByDepartment?departmentId=${node.id}`;

            try {
                const res = await fetch(url);
                const data = await res.json();

                grid.dataSource.data(data);
                $("#empCount").text(`Tổng số nhân viên: ${data.length}`);
            } catch (err) {
                console.error(err);
                $("#empCount").text("Lỗi tải dữ liệu nhân viên!");
            }
        }

        // ✅ Các hàm tiện ích khác để expand / filter TreeView
        (function () {
            function whenTreeReady(callback, tries = 30, interval = 200) {
                const id = setInterval(() => {
                    const tree = $("#deptTree").data("kendoTreeView");
                    if (tree) {
                        clearInterval(id);
                        callback(tree);
                    } else if (--tries <= 0) {
                        clearInterval(id);
                        console.warn("TreeView not initialized after waiting.");
                    }
                }, interval);
            }

            function expandAll(treeview) {
                treeview.items().each(function () { treeview.expand(this); });
            }
            function collapseAll(treeview) {
                treeview.items().each(function () { treeview.collapse(this); });
            }
            function applyFilter(treeview, text) {
                if (!text) { treeview.dataSource.filter({}); return; }
                treeview.dataSource.filter({ field: "text", operator: "contains", value: text });
                setTimeout(() => expandAll(treeview), 120);
            }

            whenTreeReady(function (treeview) {
                $("#expandAllNodes").on("click", () => expandAll(treeview));
                $("#collapseAllNodes").on("click", () => collapseAll(treeview));
                $("#filterDataSource").on("click", () => applyFilter(treeview, $("#filterText").val()));
                $("#filterText").on("input", () => applyFilter(treeview, $("#filterText").val()));
            });
        })();

    </script>
}

