@model List<PhoneBook.Models.Department>
@using Kendo.Mvc
@{
    ViewData["Title"] = "PhoneBook";
    var isAdmin = ViewBag.IsAdmin ?? false;
}

@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer

<meta charset="utf-8" />

<style>
    /* ====== BASE ====== */
    body {
        font-size: 13px;
    }

    .phonebook-container {
        padding: 10px 0;
        height: calc(100vh - 80px);
        overflow: hidden;
    }

    .section-card {
        background: #fff;
        border-radius: 6px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        padding: 12px;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .section-header {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e9ecef;
        flex-shrink: 0;
    }

        .section-header h3 {
            margin: 0;
            color: #2c3e50;
            font-weight: 600;
            font-size: 15px;
        }

    /* ====== TREE CONTROLS ====== */
    .tree-controls {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 8px;
        margin-bottom: 10px;
        flex-shrink: 0;
    }

        .tree-controls .control-group {
            margin-bottom: 6px;
        }

            .tree-controls .control-group:last-child {
                margin-bottom: 0;
            }

        .tree-controls label {
            font-size: 11px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 3px;
            display: block;
        }

    /* ====== SEARCH BOX ====== */
    .search-box {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 8px;
        margin-bottom: 10px;
        flex-shrink: 0;
    }

        .search-box label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .search-box input {
            border-radius: 3px;
            font-size: 12px;
            padding: 4px 8px;
        }

    /* ====== EMPLOYEE COUNT ====== */
    .employee-count {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 6px 12px;
        border-radius: 4px;
        text-align: center;
        font-weight: 600;
        font-size: 12px;
        margin-top: 8px;
        box-shadow: 0 1px 4px rgba(102, 126, 234, 0.3);
        flex-shrink: 0;
    }

    /* ====== TREE & GRID ====== */
    .tree-wrapper {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 6px;
        background: #fff;
    }

    .grid-wrapper {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    #deptTree {
        font-size: 12px;
    }

        #deptTree .k-in {
            padding: 4px 6px;
        }

    .k-grid {
        border-radius: 4px;
        overflow: hidden;
        font-size: 12px;
        flex: 1;
        font-family: "DejaVu Sans", Arial, sans-serif;
    }
    .k-grid-header {
        padding-right : 0px !important;
    }

    .k-grid-header th {
        font-size: 12px;
        padding: 6px 8px;
    }

    .k-grid-content td {
        padding: 4px 8px;
        font-size: 12px;
    }

    .k-pager-wrap {
        font-size: 11px;
        padding: 4px 8px;
    }

    .row-number {
        font-weight: 600;
        color: #6c757d;
    }
    /* ====== TABSTRIP ====== */
    .k-tabstrip {
        border: none;
        margin-bottom: 10px;
        flex-shrink: 0;
    }

        .k-tabstrip > .k-tabstrip-items {
            padding: 0;
            border-bottom: 2px solid #e9ecef;
        }

        .k-tabstrip .k-item {
            border: none;
            background: transparent;
            margin-right: 5px;
        }

        .k-tabstrip .k-link {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            color: #6c757d;
            border-radius: 4px 4px 0 0;
        }

        .k-tabstrip .k-item.k-state-active .k-link {
            background: #667eea;
            color: white;
        }

        .k-tabstrip .k-item:hover:not(.k-state-active) .k-link {
            background: #f8f9fa;
            color: #2c3e50;
        }

        .k-tabstrip > .k-tabstrip-content,
        .k-tabstrip-content {
            display: none !important;
        }
        .k-tabstrip .k-item.k-active {
            background: #2196F3;  /* Material Blue */
            border: 1px solid #2196F3;
        }

        .k-tabstrip .k-item.k-active .k-link {
            background: #2196F3;
            color: white;
            border-bottom: 2px solid #2196F3;
        }
        .k-tabstrip .k-item:not(.k-active):hover {
            background: #e3f2fd;  /* Light Blue */
        }

        .k-tabstrip .k-item:not(.k-active):hover .k-link {
            background: #e3f2fd;
            color: #1976D2;  /* Darker Blue */
        }
    /* ====== EXPORT PDF STYLE ====== */
    .k-pdf-export {
        font-family: 'Roboto', 'DejaVu Sans', Arial, sans-serif !important;
    }

        .k-pdf-export .k-grid-toolbar,
        .k-pdf-export .k-filter-row,
        .k-pdf-export .k-pager {
            display: none !important;
        }

    /* ====== PDF TEMPLATE ====== */
    .page-template {
        font-family: "Arial", sans-serif;
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
    }

        .page-template .header {
            position: absolute;
            top: 30px;
            left: 30px;
            right: 30px;
            border-bottom: 1px solid #888;
            color: #888;
        }

        .page-template .footer {
            position: absolute;
            bottom: 30px;
            left: 30px;
            right: 30px;
            border-top: 1px solid #888;
            text-align: center;
            color: #888;
        }

        .page-template .watermark {
            font-weight: bold;
            font-size: 400%;
            text-align: center;
            margin-top: 30%;
            color: #aaa;
            opacity: 0.1;
            transform: rotate(-35deg) scale(1.7, 1.5);
        }

    .k-grid .k-grid-content {
        overflow-y: auto !important;
    }

    @@media (max-width: 768px) {
        .phonebook-container {
            height: auto;
            overflow: auto;
        }

        .section-card {
            margin-bottom: 15px;
            height: auto;
        }
    }
</style>

<!-- ===================== MAIN VIEW ===================== -->
<div class="phonebook-container">
    <div class="row h-100">

        <!-- DEPARTMENTS TREEVIEW -->
        <div class="col-lg-3 col-md-4 h-100">
            <div class="section-card">
                <div class="tree-wrapper">
                    @(Html.Kendo().TreeView()
                                        .Name("deptTree")
                                        .DataTextField("text")
                                        .DataSource(ds => ds
                                        .Read(r => r.Url(Url.Action("GetDepartments", "Home")))
                                        .Model(m =>
                                        {
                                            m.Id("id");
                                            m.Children("items");
                                        })
                                        )
                                        .Events(e => e
                                        .Select("onDeptSelect")
                                        .DataBound("onTreeDataBound") 
                                        )
                                        )
                </div>
            </div>
        </div>

        <!-- EMPLOYEES LIST -->
        <div class="col-lg-9 col-md-7 h-100">
            <div class="section-card">
                <div class="section-header">
                    <h3><i class="fas fa-users me-2"></i><span id="departmentTitle">@Localizer["EmployeeListTitle"]</span></h3>
                </div>
                <div class="search-box">
                    <label class="form-label mb-1"><i class="fas fa-search me-1"></i>@Localizer["SearchLabel"]</label>
                    <input type="text" id="employeeSearch" class="form-control form-control-sm"
                           placeholder="@Localizer["SearchBoxPlaceholder"]" />
                </div>

                <div class="grid-wrapper">
                <!-- TABSTRIP -->
                @(Html.Kendo().TabStrip()
                        .Name("employeeTabStrip")
                        .Items(items =>
                        {
                            items.Add()
                                .Text(@Localizer["ActiveEmployees"].Value)
                                .Selected(true)
                                .HtmlAttributes(new { id = "tab-active" });

                            items.Add()
                            .Text(@Localizer["InactiveEmployees"].Value)
                            .HtmlAttributes(new { id = "tab-inactive" });
                    })
                    .Events(e => e.Select("onTabSelect"))
                )
                <!-- GRID -->
                @(Html.Kendo().Grid<PhoneBook.Models.Employee>()
                    .Name("employeeGrid")
                    .ToolBar(tools => { 
                                            tools.Pdf(); 
                                            tools.Excel();
                                        })
                                        .Excel(excel => excel.FileName("PhoneBook_Export.xlsx").AllPages(true))
                                        .Pdf(pdf => pdf
                                        .AllPages()
                                        .AvoidLinks()
                                        .PaperSize("A4")
                                        .Scale(0.8)
                                        .Margin("2cm", "1cm", "1cm", "1cm")
                                        .Landscape()
                                        .TemplateId("page-template")
                                        .FileName("PhoneBook.pdf")
                                        .ProxyURL(Url.Action("Pdf_Export_Save", "Grid"))
                                        .ForceProxy(true)
                                        )
                                        .Columns(columns =>
                                        {
                                            columns.Template("<span class='row-number'></span>")
                                            .Title(@Localizer["Column_STT"].Value)
                                            .Width(60)
                                            .HtmlAttributes(new { @class = "text-center" })
                        @*  .Locked(true) *@
                        ;

                                                columns.Bound(e => e.FullName)
                                                .Title(@Localizer["Column_FullName"].Value)
                                                .Width(240);

                                                columns.Bound(e => e.WorkingPhone)
                                                .Title(@Localizer["Column_WorkPhone"].Value)
                                                .Width(200)
                                                .HtmlAttributes(new { @class = "text-center" });

                                                columns.Bound(e => e.HandPhone)
                                                .Title(@Localizer["Column_Mobile"].Value)
                                                .Width(200)
                                                .HtmlAttributes(new { @class = "text-center" });

                                                columns.Bound(e => e.BusinessEmail)
                                                .Title(@Localizer["Column_BusinessEmail"].Value)
                                                .Width(200)
                                                .HtmlAttributes(new { @class = "text-center" });
                                                if (isAdmin)
                                                {
                                                    columns.Command(command =>
                                                    {
                                                        command
                                                        .Edit()
                                                        .Text(" ")
                                                        .UpdateText("Save")
                                                        .CancelText("Cancel");
                                                    }).Width(240);
                                                }
                                        })
                                        .Sortable()
                                   @*      .Filterable(f => f.Mode(GridFilterMode.Menu)) *@
                                         .ColumnMenu(menu => menu
                                         .Enabled(true)
                                         .Filterable(false))
                                         .Groupable(false)
                                        .Resizable(resize => resize.Columns(true))
                                        .Reorderable(reorder => reorder.Columns(true))
                                        .Pageable(page => page
                                        .PageSizes(new int[] { 10, 15, 20, 30, 50, 100 })
                                        .ButtonCount(5)
                                        .Messages(m => m
                                        .ItemsPerPage(@Localizer["ItemsPerPageMsg"].Value)
                                        .Display(@Localizer["DisplayMsg"].Value)
                                        .Empty(@Localizer["EmptyMsg"].Value)
                                        .First(@Localizer["FirstMsg"].Value)
                                        .Last(@Localizer["LastMsg"].Value)
                                        .Next(@Localizer["NextMsg"].Value)
                                        .Previous(@Localizer["PreviousMsg"].Value)
                                        .Refresh(@Localizer["RefreshMsg"].Value)
                                        )
                                        ).DataSource(ds => ds
                                        .Ajax()
                                        .ServerOperation(false)
                                        .PageSize(15)
                                        .Model(m => m.Id(e => e.UserId))
                                        .Read(read => read.Action("GetAllEmployees", "Home").Type(HttpVerbs.Get))
                                        .Update(update => update.Action("UpdateEmployee", "Home").Type(HttpVerbs.Post))
                                        )
                                        .Scrollable()
                                        .Events(e => e
                                        .DataBound("onGridDataBound")
                                        .Save("onGridSave")
                                        .Cancel("onGridCancel")
                                        )
                                        )
                </div>

                <div id="empCount" class="employee-count">
                    <i class="fas fa-user-check me-2"></i><span>@Localizer["LoadingEmployees"]</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===================== SCRIPTS ===================== -->
@section Scripts {
    <script type="x/kendo-template" id="page-template">
            <div class="page-template">
                <div class="header">
                    <div style="float:right">@Localizer["PdfFooterText"]</div>
                    PhoneBook
                </div>
                <div class="watermark">SAGS</div>
        <div class="footer">@Localizer["PdfFooterText"]</div>
            </div>
    </script>

    <script>
        var IsAdmin = @Json.Serialize(isAdmin);
        var rootDepartmentName = ""; // tên root department
        var currentDepartmentId = null;
        var currentTab = "active";
        $(document).ready(function () {
            kendo.pdf.defineFont({
                "DejaVu Sans": "https://kendo.cdn.telerik.com/2023.1.117/styles/fonts/DejaVu/DejaVuSans.ttf",
                "DejaVu Sans|Bold": "https://kendo.cdn.telerik.com/2023.1.117/styles/fonts/DejaVu/DejaVuSans-Bold.ttf",
                "DejaVu Sans|Italic": "https://kendo.cdn.telerik.com/2023.1.117/styles/fonts/DejaVu/DejaVuSans-Oblique.ttf",
                "DejaVu Sans|Bold|Italic": "https://kendo.cdn.telerik.com/2023.1.117/styles/fonts/DejaVu/DejaVuSans-BoldOblique.ttf"
            });

            const grid = $("#employeeGrid").data("kendoGrid");
    
            // TỰ ĐỘNG CHỌN NODE ROOT KHI TREEVIEW READY
            setTimeout(function() {
                const tree = $("#deptTree").data("kendoTreeView");
                if (tree) {
                    // Tìm node root (parentId === -1 hoặc "-1")
                    const rootNode = tree.element.find("li:first");
                    if (rootNode.length > 0) {
                        tree.select(rootNode);
                        tree.trigger("select", { node: rootNode[0] });
                    }
                }
            }, 500);

            $("#employeeSearch").on("input", function () {
                const val = $(this).val().toLowerCase();
                grid.dataSource.filter(!val ? {} : {
                    logic: "or",
                    filters: [
                        { field: "FullName", operator: "contains", value: val },
                        { field: "WorkingPhone", operator: "contains", value: val },
                        { field: "HandPhone", operator: "contains", value: val },
                        { field: "BusinessEmail", operator: "contains", value: val }
                    ]
                });
            });

            adjustGridHeight();
            $(window).on("resize", adjustGridHeight);
        });
        // TabStrip Select
        function onTabSelect(e) {
            const selectedTab = $(e.item).attr("id");
            currentTab = selectedTab === "tab-active" ? "active" : "inactive";
            
            // Clear search box
            $("#employeeSearch").val("");
            
            // Reload data based on current department and tab
            loadEmployeesByTab();
        }
        function onTreeDataBound(e) { //khi cây thay đổi
            const tree = this;
    
            // Expand node root (li đầu tiên)
            const rootNode = tree.element.find("li:first");
            if (rootNode.length > 0) {
            // Lưu tên root department
            const rootDataItem = tree.dataItem(rootNode);
            if (rootDataItem) {
                rootDepartmentName = rootDataItem.text || "";
                updateDepartmentTitle(rootDepartmentName, true);
            }
            
            tree.expand(rootNode);
        
                // Select root node để load tất cả nhân viên
                setTimeout(function() {
                    tree.select(rootNode);
                    tree.trigger("select", { node: rootNode[0] });
                }, 100);
            }
        }
        function updateDepartmentTitle(departmentName, isRoot = false) { // cập nhật tiêu đề khi click ở tree
            const title = departmentName || "@Localizer["EmployeeListTitle"]";
            $("#departmentTitle").text(title);
        }
        function getDepartmentPath(tree, node) {
            const path = [];
            let currentNode = node;
        
            while (currentNode) {
                const dataItem = tree.dataItem(currentNode);
                if (dataItem) {
                    path.unshift(dataItem.text);
                
                    // Tìm parent node
                    const parentNode = tree.parent(currentNode);
                    if (parentNode && parentNode.length > 0) {
                        currentNode = parentNode;
                    } else {
                        break;
                    }
                } else {
                    break;
                }
        }
        
        return path;
    }
        function onGridSave(e) {
            setTimeout(function () {
                const grid = $("#employeeGrid").data("kendoGrid");
                if (grid) onGridDataBound.call(grid);
            }, 200);
        if(e.values){ kendo.alert("Updated");}
        }
        function onGridCancel(e) {
            // Sau khi cancel, render lại STT
            setTimeout(function () {
                const grid = $("#employeeGrid").data("kendoGrid");
                if (grid) onGridDataBound.call(grid);
            }, 200);

        }
        function adjustGridHeight() {          // Modify Table heigth when scroll and load data
            const gridWrapper = $(".grid-wrapper");
            const grid = $("#employeeGrid").data("kendoGrid");
            if (!grid) return;

            const h = gridWrapper.height();
            const g = grid.wrapper;
            const header = g.find(".k-grid-header").outerHeight();
            const pager = g.find(".k-grid-pager").outerHeight();
            g.find(".k-grid-content").height(h - header - pager - 10);
        }

        async function loadEmployeesByTab() {
            const grid = $("#employeeGrid").data("kendoGrid");
            
            let url;
            if (currentDepartmentId === null || currentDepartmentId === -1 || currentDepartmentId === "-1") {
                // Root department - load all employees
                url = currentTab === "active" 
                    ? "/Home/GetAllEmployees" 
                    : "/Home/GetAllInactiveEmployees";
            } else {
                // Specific department
                url = currentTab === "active"
                    ? `/Home/GetEmployeesByDepartment?departmentId=${currentDepartmentId}`
                    : `/Home/GetInactiveEmployeesByDepartment?departmentId=${currentDepartmentId}`;
            }

            try {
                const res = await fetch(url);
                const data = await res.json();
                grid.dataSource.data(data);
                updateEmployeeCount(data.length);
            } catch {
                $("#empCount").html(`<i class="fas fa-exclamation-triangle me-2"></i>@Localizer["LoadError"]`);
            }
        }

        function onGridDataBound(e) {
            const grid = this;
            const rows = grid.items();
            let index = (grid.dataSource.page() - 1) * grid.dataSource.pageSize();
            rows.each(function () {
                $(this).find(".row-number").text(++index);
            });
            updateEmployeeCount(grid.dataSource.total());
            adjustGridHeight();
        }

        function updateEmployeeCount(count) {
            const statusText = currentTab === "active" ? "@Localizer["TotalEmployees"]" : "@Localizer["TotalInactiveEmployees"]";
            $("#empCount").html(`<i class="fas fa-user-check me-2"></i>${statusText} <strong>${count}</strong>`);
        }

        async function onDeptSelect(e) {
            const tree = $("#deptTree").data("kendoTreeView");
            const node = tree.dataItem(e.node);
            const grid = $("#employeeGrid").data("kendoGrid");
            $("#employeeSearch").val("");

            currentDepartmentId = node.id;
            // Cập nhật tiêu đề phòng ban
            if (node.parentId === -1 || node.parentId === "-1") {
                // Nếu là root, hiển thị tên root
                updateDepartmentTitle(node.text, true);
            } else {
                // Nếu là phòng ban con, hiển thị đường dẫn: Phòng ban cha - Phòng ban con
                const path = getDepartmentPath(tree, e.node);
                const title = path.length > 1 ? path.join(" - ") : path[0] || node.text;
                updateDepartmentTitle(title, false);
            }
            await loadEmployeesByTab();
            // const url = (node.parentId === -1 || node.parentId === "-1")
            //     ? "/Home/GetAllEmployees"
            //     : `/Home/GetEmployeesByDepartment?departmentId=${node.id}`;

            // try {
            //     const res = await fetch(url);
            //     const data = await res.json();
            //     grid.dataSource.data(data);
            //     updateEmployeeCount(data.length);
            // } catch {
            //     $("#empCount").html(`<i class="fas fa-exclamation-triangle me-2"></i>@Localizer["LoadError"]`);
            // }
        }

        (function initTreeControls() {
            function whenTreeReady(cb, tries = 30) {
                const i = setInterval(() => {
                    const t = $("#deptTree").data("kendoTreeView");
                    if (t || --tries <= 0) {
                        clearInterval(i);
                        if (t) cb(t);
                    }
                }, 200);
            }

            // function expandAll(t) { t.items().each(function () { t.expand(this); }); }
            // function collapseAll(t) { t.items().each(function () { t.collapse(this); }); }
            // function applyFilter(t, text) {
            //     if (!text) return t.dataSource.filter({});
            //     t.dataSource.filter({ field: "text", operator: "contains", value: text });
            //     setTimeout(() => expandAll(t), 120);
            // }
            // whenTreeReady(t => {
            //     $("#expandAllNodes").on("click", () => expandAll(t));
            //     $("#collapseAllNodes").on("click", () => collapseAll(t));
            //     // $("#filterText").on("input", () => applyFilter(t, $("#filterText").val()));
            // });
        })();

    </script>
}
